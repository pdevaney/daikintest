<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Exams</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root{
      --bg:#f6f6f6;
      --card:#fff;
      --border:#ddd;
      --muted:#666;
      --header:#fafafa;
      --rowEven:#fcfcfc;
      --rowOdd:#ffffff;
      --primary:#005eb8;
      --primaryHover:#004a92;
      --danger:#b00020;
      --shadow: 0 6px 18px rgba(0,0,0,0.06);
    }

    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      margin: 24px;
      background: var(--bg);
      color:#222;
    }

    .card{
      background: var(--card);
      padding: 20px;
      border-radius: 8px;
      max-width: 1250px;
      margin: 0 auto;
      box-shadow: var(--shadow);
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      margin-bottom: 12px;
    }

    h1{
      margin: 0;
      font-size: 24px;
    }

    .actions{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }

    .search{
      display:flex;
      gap:8px;
      align-items:center;
    }

    input, select{
      font-family: inherit;
      font-size: 14px;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      box-sizing: border-box;
      background: #fff;
    }

    button{
      border: none;
      border-radius: 6px;
      cursor: pointer;
      padding: 10px 14px;
      font-size: 14px;
      color: #fff;
      background: var(--primary);
    }
    button:hover{ background: var(--primaryHover); }
    button.secondary{
      background:#666;
    }
    button.secondary:hover{ background:#555; }
    button.ghost{
      background: transparent;
      color: var(--primary);
      border: 1px solid #c9d7ea;
    }
    button.ghost:hover{
      background:#f2f7ff;
    }

    /* Table */
    .table-wrap{
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
      background: #fff;
    }

    table{
      width:100%;
      border-collapse: separate;
      border-spacing: 0;
      font-size: 14px;
    }

    thead th{
      position: sticky;
      top: 0;
      background: var(--header);
      text-align:left;
      font-weight: 700;
      font-size: 12px;
      color:#444;
      padding: 12px 12px;
      border-bottom: 2px solid var(--border);
      z-index: 1;
      white-space: nowrap;
    }

    tbody td{
      padding: 12px 12px;
      border-bottom: 1px solid #eee;
      vertical-align: top;
    }

    tbody tr:nth-child(even){ background: var(--rowEven); }
    tbody tr:nth-child(odd){ background: var(--rowOdd); }

    tbody tr.clickable{
      cursor:pointer;
    }
    tbody tr.clickable:hover{
      background:#eef4ff;
    }

    .pill{
      display:inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px solid #ddd;
      color:#333;
      background:#fff;
      white-space: nowrap;
    }
    .pill.published{
      background:#e9f8ee;
      border-color:#bfe6c9;
      color:#15552e;
      font-weight: 700;
    }
    .pill.inprogress{
      background:#fff6dd;
      border-color:#f3dfa4;
      color:#6a5200;
      font-weight: 700;
    }

    .muted{
      color: var(--muted);
      font-size: 12px;
      margin-top: 8px;
    }

    /* Modal */
    .modal-backdrop{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.35);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 18px;
      z-index: 999;
    }
    .modal{
      width: 100%;
      max-width: 760px;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 16px 40px rgba(0,0,0,0.18);
      overflow: hidden;
    }
    .modal-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 14px 16px;
      background: #fafafa;
      border-bottom: 1px solid #e6e6e6;
    }
    .modal-title{
      margin:0;
      font-size: 16px;
      font-weight: 800;
      color:#222;
    }
    .modal-body{
      padding: 16px;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
      margin-bottom: 14px;
    }
    .field{
      display:flex;
      flex-direction:column;
      gap: 6px;
    }
    .field label{
      font-size: 13px;
      color:#555;
    }

    .divider{
      height: 1px;
      background:#eee;
      margin: 14px 0;
    }

    .modal-footer{
      padding: 14px 16px;
      border-top: 1px solid #e6e6e6;
      background:#fafafa;
      display:flex;
      justify-content:flex-end;
      gap:10px;
      flex-wrap:wrap;
    }

    /* Languages list inside exam modal */
    .lang-table{
      width:100%;
      border: 1px solid #e6e6e6;
      border-radius: 8px;
      overflow: hidden;
    }
    .lang-table table{
      width:100%;
      border-collapse: collapse;
    }
    .lang-table th, .lang-table td{
      padding: 10px 12px;
      border-bottom: 1px solid #eee;
      text-align:left;
    }
    .lang-table th{
      background:#fafafa;
      font-size: 12px;
      color:#444;
    }
    .status-chip{
      display:inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px solid #ddd;
      background:#fff;
      white-space: nowrap;
    }
    .chip-translation{ background:#eef4ff; border-color:#c8d8ff; color:#20355d; font-weight:700; }
    .chip-review{ background:#fff1bf; border-color:#f0df95; color:#6a5200; font-weight:700; }
    .chip-submitted{ background:#e9f8ee; border-color:#bfe6c9; color:#15552e; font-weight:700; }
    .chip-published{ background:#f1f1f1; border-color:#d8d8d8; color:#333; font-weight:700; }

    /* Template selector */
    .template-box{
      border: 1px solid #e1e1e1;
      border-radius: 8px;
      padding: 10px;
      background:#fff;
    }
    .template-list{
      display:flex;
      flex-direction:column;
      gap:8px;
      max-height: 170px;
      overflow:auto;
      padding-right: 4px;
    }
    .template-item{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 8px 10px;
      border: 1px solid #eee;
      border-radius: 8px;
      background:#fff;
    }
    .template-item:hover{ background:#f7fbff; border-color:#dfeeff; }
    .template-left{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 0;
    }
    .template-left input{
      transform: scale(1.12);
      flex-shrink: 0;
    }
    .template-code{
      font-weight: 800;
      font-size: 13px;
      color:#222;
      white-space: nowrap;
    }
    .template-name{
      font-size: 13px;
      color:#555;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .template-meta{
      font-size: 12px;
      color:#555;
      white-space: nowrap;
    }

    @media (max-width: 820px){
      .grid{ grid-template-columns: 1fr; }
      body{ margin: 12px; }
      .actions{ width:100%; justify-content:space-between; }
      .search{ width:100%; }
      .search input{ flex:1; width:100%; }
    }
  </style>
</head>

<body>
  <div class="card">
    <div class="topbar">
      <h1>Exams</h1>

      <div class="actions">
        <div class="search">
          <input id="search" placeholder="Search code or name…" />
        </div>
        <button id="createExamBtn">Create exam</button>
      </div>
    </div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th style="width:120px;">Exam code</th>
            <th>Exam name</th>
            <th style="width:110px;">Level</th>
            <th style="width:110px;">Pillar</th>
            <th style="width:140px;">Status</th>
          </tr>
        </thead>
        <tbody id="examsBody"></tbody>
      </table>
    </div>

    <div class="muted">
      Click an exam to view translation/review status by language.
    </div>
  </div>

  <!-- Exam details modal -->
  <div class="modal-backdrop" id="examModalBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="examModalTitle">
      <div class="modal-header">
        <h3 class="modal-title" id="examModalTitle">Exam</h3>
        <button class="ghost" id="closeExamModalBtn" type="button">Close</button>
      </div>
      <div class="modal-body">
        <div id="examModalMeta" class="muted" style="margin:0 0 10px 0;"></div>

        <div class="lang-table">
          <table>
            <thead>
              <tr>
                <th>Language</th>
                <th style="width:220px;">Review status</th>
              </tr>
            </thead>
            <tbody id="langBody"></tbody>
          </table>
        </div>

        <div class="muted" style="margin-top:10px;">
          Status values: In translation, In review, Submitted, Published.
        </div>
      </div>
      <div class="modal-footer">
        <button class="secondary" id="closeExamModalBtn2" type="button">Close</button>
      </div>
    </div>
  </div>

  <!-- Create exam modal -->
  <div class="modal-backdrop" id="createModalBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="createModalTitle">
      <div class="modal-header">
        <h3 class="modal-title" id="createModalTitle">Create exam</h3>
        <button class="ghost" id="closeCreateModalBtn" type="button">Close</button>
      </div>

      <div class="modal-body">
        <div class="grid">
          <div class="field">
            <label>Exam Code</label>
            <input id="newExamCode" placeholder="e.g. EX-404" />
          </div>

          <div class="field">
            <label>Exam Name</label>
            <input id="newExamName" placeholder="e.g. Refrigeration Essentials" />
          </div>

          <div class="field">
            <label>Level</label>
            <select id="newExamLevel">
              <option>Level 1</option>
              <option>Level 2</option>
              <option>Level 3</option>
            </select>
          </div>

          <div class="field">
            <label>Pillar</label>
            <select id="newExamPillar">
              <option>Pillar A</option>
              <option>Pillar B</option>
            </select>
          </div>
        </div>

        <div class="divider"></div>

        <div class="field">
          <label>Template (select one or more existing exams)</label>
          <div class="template-box">
            <div class="template-list" id="templateList"></div>
          </div>
          <div class="muted" style="margin-top:8px;">
            Selecting a template will set the Level and Pillar by default (you can change them).
          </div>
        </div>

        <div class="divider"></div>

        <div class="muted">
          When you click “Create”, this demo adds the exam to the list with Status = In progress.
        </div>
      </div>

      <div class="modal-footer">
        <button class="secondary" id="cancelCreateBtn" type="button">Cancel</button>
        <button id="confirmCreateBtn" type="button">Create</button>
      </div>
    </div>
  </div>

  <script>
    // ----------------------------
    // Sample data
    // ----------------------------
    const exams = [
      {
        code: "EX-101",
        name: "Foundations of Safety",
        level: "Level 1",
        pillar: "Pillar A",
        status: "Published",
        languages: [
          { lang: "English",  reviewStatus: "Published" },
          { lang: "Japanese", reviewStatus: "In review" },
          { lang: "French",   reviewStatus: "In translation" },
        ]
      },
      {
        code: "EX-202",
        name: "Advanced Operations",
        level: "Level 2",
        pillar: "Pillar A",
        status: "In progress",
        languages: [
          { lang: "English",  reviewStatus: "Published" },
          { lang: "Japanese", reviewStatus: "In translation" },
          { lang: "German",   reviewStatus: "Submitted" },
        ]
      },
      {
        code: "EX-303",
        name: "Expert Assessment",
        level: "Level 3",
        pillar: "Pillar B",
        status: "Published",
        languages: [
          { lang: "English",              reviewStatus: "Published" },
          { lang: "Chinese (Simplified)", reviewStatus: "Published" },
          { lang: "Korean",               reviewStatus: "Submitted" },
        ]
      }
    ];

    // ----------------------------
    // Helpers
    // ----------------------------
    function normalize(s){ return String(s || "").toLowerCase().trim(); }
    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function statusPill(status){
      const s = normalize(status);
      if (s === "published") return `<span class="pill published">Published</span>`;
      return `<span class="pill inprogress">In progress</span>`;
    }

    function langChip(status){
      const s = normalize(status);
      if (s === "in translation") return `<span class="status-chip chip-translation">In translation</span>`;
      if (s === "in review") return `<span class="status-chip chip-review">In review</span>`;
      if (s === "submitted") return `<span class="status-chip chip-submitted">Submitted</span>`;
      return `<span class="status-chip chip-published">Published</span>`;
    }

    // ----------------------------
    // Render exams table
    // ----------------------------
    const examsBody = document.getElementById("examsBody");
    const searchEl = document.getElementById("search");

    function renderExams(){
      const q = normalize(searchEl.value);
      const filtered = exams.filter(e => {
        if (!q) return true;
        return normalize(e.code).includes(q) || normalize(e.name).includes(q);
      });

      examsBody.innerHTML = filtered.map(e => `
        <tr class="clickable" data-code="${escapeHtml(e.code)}" title="Click to view language statuses">
          <td><strong>${escapeHtml(e.code)}</strong></td>
          <td>${escapeHtml(e.name)}</td>
          <td>${escapeHtml(e.level)}</td>
          <td>${escapeHtml(e.pillar)}</td>
          <td>${statusPill(e.status)}</td>
        </tr>
      `).join("");

      // Row click -> open modal
      examsBody.querySelectorAll("tr[data-code]").forEach(row => {
        row.addEventListener("click", () => {
          const code = row.getAttribute("data-code");
          const exam = exams.find(x => x.code === code);
          if (exam) openExamModal(exam);
        });
      });
    }

    searchEl.addEventListener("input", renderExams);

    // ----------------------------
    // Exam modal (languages & statuses)
    // ----------------------------
    const examModalBackdrop = document.getElementById("examModalBackdrop");
    const examModalTitle = document.getElementById("examModalTitle");
    const examModalMeta = document.getElementById("examModalMeta");
    const langBody = document.getElementById("langBody");

    function openExamModal(exam){
      examModalTitle.textContent = `${exam.code} – ${exam.name}`;
      examModalMeta.textContent = `${exam.level} • ${exam.pillar} • Status: ${exam.status}`;
      langBody.innerHTML = (exam.languages || []).map(l => `
        <tr>
          <td>${escapeHtml(l.lang)}</td>
          <td>${langChip(l.reviewStatus)}</td>
        </tr>
      `).join("");

      showModal(examModalBackdrop);
    }

    function closeExamModal(){
      hideModal(examModalBackdrop);
    }

    document.getElementById("closeExamModalBtn").addEventListener("click", closeExamModal);
    document.getElementById("closeExamModalBtn2").addEventListener("click", closeExamModal);

    // ----------------------------
    // Create Exam modal
    // ----------------------------
    const createModalBackdrop = document.getElementById("createModalBackdrop");
    const createExamBtn = document.getElementById("createExamBtn");
    const closeCreateModalBtn = document.getElementById("closeCreateModalBtn");
    const cancelCreateBtn = document.getElementById("cancelCreateBtn");
    const confirmCreateBtn = document.getElementById("confirmCreateBtn");

    const newExamCode = document.getElementById("newExamCode");
    const newExamName = document.getElementById("newExamName");
    const newExamLevel = document.getElementById("newExamLevel");
    const newExamPillar = document.getElementById("newExamPillar");
    const templateList = document.getElementById("templateList");

    function renderTemplates(){
      // Show existing exams as selectable templates
      templateList.innerHTML = exams.map(e => `
        <div class="template-item">
          <div class="template-left">
            <input type="checkbox" class="template-check" value="${escapeHtml(e.code)}" />
            <div style="min-width:0;">
              <div class="template-code">${escapeHtml(e.code)}</div>
              <div class="template-name">${escapeHtml(e.name)}</div>
            </div>
          </div>
          <div class="template-meta">${escapeHtml(e.level)} • ${escapeHtml(e.pillar)}</div>
        </div>
      `).join("");

      templateList.querySelectorAll(".template-check").forEach(cb => {
        cb.addEventListener("change", () => applyDefaultsFromTemplateSelection());
      });
    }

    function applyDefaultsFromTemplateSelection(){
      // Default Level/Pillar from the FIRST selected template (simple + predictable).
      const selected = Array.from(templateList.querySelectorAll(".template-check:checked"))
        .map(cb => cb.value);

      if (!selected.length) return;

      const first = exams.find(e => e.code === selected[0]);
      if (!first) return;

      newExamLevel.value = first.level;
      newExamPillar.value = first.pillar;
    }

    function openCreateModal(){
      // reset fields
      newExamCode.value = "";
      newExamName.value = "";
      newExamLevel.value = "Level 1";
      newExamPillar.value = "Pillar A";

      renderTemplates();
      showModal(createModalBackdrop);
    }

    function closeCreateModal(){
      hideModal(createModalBackdrop);
    }

    createExamBtn.addEventListener("click", openCreateModal);
    closeCreateModalBtn.addEventListener("click", closeCreateModal);
    cancelCreateBtn.addEventListener("click", closeCreateModal);

    confirmCreateBtn.addEventListener("click", () => {
      const code = newExamCode.value.trim();
      const name = newExamName.value.trim();
      const level = newExamLevel.value;
      const pillar = newExamPillar.value;

      if (!code || !name){
        alert("Please enter both Exam Code and Exam Name.");
        return;
      }
      if (exams.some(e => normalize(e.code) === normalize(code))){
        alert("That exam code already exists. Please choose another.");
        return;
      }

      const selectedTemplates = Array.from(templateList.querySelectorAll(".template-check:checked"))
        .map(cb => cb.value);

      // Demo: create the exam and copy language list from templates (unique languages)
      const languageMap = new Map();
      selectedTemplates.forEach(tcode => {
        const t = exams.find(e => e.code === tcode);
        (t?.languages || []).forEach(l => {
          if (!languageMap.has(l.lang)) {
            // New exam translations start as "In translation" (except English published in this demo)
            languageMap.set(l.lang, { lang: l.lang, reviewStatus: l.lang === "English" ? "Published" : "In translation" });
          }
        });
      });

      // If no templates selected, give a basic default set
      if (languageMap.size === 0) {
        ["English", "Japanese"].forEach(l => {
          languageMap.set(l, { lang: l, reviewStatus: l === "English" ? "Published" : "In translation" });
        });
      }

      exams.unshift({
        code,
        name,
        level,
        pillar,
        status: "In progress",
        languages: Array.from(languageMap.values())
      });

      closeCreateModal();
      renderExams();

      // optional: open the newly created exam modal
      const created = exams.find(e => e.code === code);
      if (created) openExamModal(created);
    });

    // ----------------------------
    // Modal utilities
    // ----------------------------
    function showModal(backdrop){
      backdrop.style.display = "flex";
      backdrop.setAttribute("aria-hidden", "false");
    }
    function hideModal(backdrop){
      backdrop.style.display = "none";
      backdrop.setAttribute("aria-hidden", "true");
    }

    // Click outside modal closes
    [examModalBackdrop, createModalBackdrop].forEach(backdrop => {
      backdrop.addEventListener("click", (e) => {
        if (e.target === backdrop) hideModal(backdrop);
      });
    });

    // ESC closes topmost
    document.addEventListener("keydown", (e) => {
      if (e.key !== "Escape") return;
      if (createModalBackdrop.style.display === "flex") hideModal(createModalBackdrop);
      else if (examModalBackdrop.style.display === "flex") hideModal(examModalBackdrop);
    });

    // Initial render
    renderExams();
  </script>
</body>
</html>
